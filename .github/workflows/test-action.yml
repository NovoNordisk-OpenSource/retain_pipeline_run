name: Test Retain Artifacts Action

on:
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Test scenario'
        required: true
        default: 'basic'
        type: choice
        options:
          - basic
          - large-artifacts
          - no-artifacts

permissions:
  contents: read
  actions: read

jobs:
  create_test_artifacts:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Create test artifacts
        run: |
          mkdir -p test-outputs

          if [ "${{ inputs.test_scenario }}" != "no-artifacts" ]; then
            # Create basic test files
            echo "Test log from run ${{ github.run_id }}" > test-outputs/test.log
            echo '{"test": true, "run_id": "${{ github.run_id }}", "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > test-outputs/test-data.json
            echo "# Test Report" > test-outputs/test-report.md
            echo "All tests passed successfully." >> test-outputs/test-report.md

            if [ "${{ inputs.test_scenario }}" = "large-artifacts" ]; then
              # Create larger files for performance testing
              dd if=/dev/zero of=test-outputs/large-file.bin bs=1M count=5
              echo "Large file created" > test-outputs/large-file.log
            fi
          fi

      - name: Upload test artifacts (basic)
        if: inputs.test_scenario != 'no-artifacts'
        uses: actions/upload-artifact@v4
        with:
          name: test-basic-artifacts
          path: test-outputs/*.log

      - name: Upload test artifacts (data)
        if: inputs.test_scenario != 'no-artifacts'
        uses: actions/upload-artifact@v4
        with:
          name: test-data-artifacts
          path: test-outputs/*.json

      - name: Upload test artifacts (reports)
        if: inputs.test_scenario != 'no-artifacts'
        uses: actions/upload-artifact@v4
        with:
          name: test-report-artifacts
          path: test-outputs/*.md

      - name: Upload large artifacts
        if: inputs.test_scenario == 'large-artifacts'
        uses: actions/upload-artifact@v4
        with:
          name: test-large-artifacts
          path: test-outputs/*.bin

  test_retain_artifacts:
    needs: create_test_artifacts
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
      actions: read
    steps:
      - name: Test the retain-artifacts action
        id: test_action
        uses: ./  # Test the local action
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: "Test Release - ${{ inputs.test_scenario }} - ${{ github.run_id }}"
          release_body: |
            ## ðŸ§ª Test Release

            This is a test release to verify the retain-artifacts action works correctly.

            **Test Configuration:**
            - Scenario: ${{ inputs.test_scenario }}
            - Run ID: ${{ github.run_id }}
            - Commit: ${{ github.sha }}
            - Triggered by: @${{ github.actor }}

            **Expected Results:**
            ${{ inputs.test_scenario == 'no-artifacts' && '- Should handle zero artifacts gracefully' || '- Should attach all test artifacts to this release' }}
            ${{ inputs.test_scenario == 'large-artifacts' && '- Should handle larger artifacts efficiently' || '' }}

            This release tests the action's functionality end-to-end.
          prerelease: true

      - name: Verify test results
        run: |
          echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Scenario**: ${{ inputs.test_scenario }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release ID**: ${{ steps.test_action.outputs.release_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL**: [${{ steps.test_action.outputs.release_tag }}](${{ steps.test_action.outputs.release_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts Count**: ${{ steps.test_action.outputs.artifacts_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Immutable Assessment**: ${{ steps.test_action.outputs.immutable_releases_enabled }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Validate expected results
          if [ "${{ inputs.test_scenario }}" = "no-artifacts" ]; then
            if [ "${{ steps.test_action.outputs.artifacts_count }}" = "0" ]; then
              echo "âœ… **No artifacts test**: PASSED" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **No artifacts test**: FAILED (expected 0, got ${{ steps.test_action.outputs.artifacts_count }})" >> $GITHUB_STEP_SUMMARY
            fi
          else
            if [ "${{ steps.test_action.outputs.artifacts_count }}" -gt "0" ]; then
              echo "âœ… **Artifacts retention test**: PASSED" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Artifacts retention test**: FAILED (expected > 0, got ${{ steps.test_action.outputs.artifacts_count }})" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [ -n "${{ steps.test_action.outputs.release_url }}" ]; then
            echo "âœ… **Release creation**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Release creation**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

  cleanup_old_test_releases:
    runs-on: ubuntu-latest
    needs: test_retain_artifacts
    if: always()
    steps:
      - name: Cleanup old test releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ§¹ Cleaning up old test releases..."

          # Delete test releases older than 24 hours
          CUTOFF_DATE=$(date -d "1 day ago" -u +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -j -f "%s" $(($(date +%s) - 86400)) +%Y-%m-%dT%H:%M:%SZ)

          gh release list --limit 50 --json tagName,name,createdAt,prerelease | \
          jq -r --arg cutoff "$CUTOFF_DATE" '.[] |
            select(.name | test("Test Release")) |
            select(.createdAt < $cutoff) |
            .tagName' | \
          while read -r tag; do
            if [ -n "$tag" ]; then
              echo "Deleting old test release: $tag"
              gh release delete "$tag" --yes || echo "Failed to delete $tag"
            fi
          done

          echo "âœ… Cleanup completed"